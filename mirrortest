#!/bin/bash

# Function to get the country code
get_country_code() {
    country_code=$(curl -s http://ip-api.com/json/ | jq -r .countryCode)
    echo "$country_code"
}

# Function to fetch mirrors for the given country code using netselect-apt
fetch_fastest_mirror() {
    country_code="$1"
    temp_file=$(mktemp)
    
    sudo netselect-apt -c "$country_code" -o "$temp_file"
    
    if [ -f "$temp_file" ]; then
        fastest_mirror=$(grep -E '^deb ' "$temp_file" | awk '{print $2}')
        rm -f "$temp_file"
    else
        fastest_mirror=""
    fi
    
    echo "$fastest_mirror"
}

# Function to update sources.list with the fastest mirror
update_sources_list() {
    fastest_mirror="$1"
    sources_list_path="/etc/apt/sources.list"
    mirror_entry="deb $fastest_mirror stable main contrib non-free"

    echo "$mirror_entry" | sudo tee "$sources_list_path" > /dev/null
    sudo apt-get update
}

# Main script execution
country_code=$(get_country_code)
echo "Detected country code: $country_code"

fastest_mirror=$(fetch_fastest_mirror "$country_code")
if [ -n "$fastest_mirror" ]; then
    echo "Fastest mirror: $fastest_mirror"
    update_sources_list "$fastest_mirror"
else
    echo "No responsive mirrors found"
fi

